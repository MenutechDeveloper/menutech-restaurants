<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Biblioteca Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
    --bg-gradient-start: #0D1117;
    --bg-gradient-end: #161B22;
    --primary-text: #E6EDF3;
    --secondary-text: #8B949E;
    --accent-color: #58A6FF;
    --accent-hover: #79C0FF;
    --border-color: #30363D;
    --surface-color: #161B22;
    --surface-hover: #21262D;
    --shadow-color: rgba(0, 0, 0, 0.4);
    --font-family: 'Inter', sans-serif;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family);
    color: var(--primary-text);
    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    overflow-x: hidden;
    padding-bottom: 120px; /* Space for player */
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.brand {
    display: flex;
    align-items: center;
    gap: 16px;
}

.brand .logo {
    width: 156px;
    height: auto;
}

.brand h1 {
    font-size: 24px;
    font-weight: 700;
}

.controls {
    display: flex;
    align-items: center;
    gap: 16px;
}

.search-box {
    position: relative;
}

.search-box i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-text);
}

#search-input {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 14px 10px 40px;
    color: var(--primary-text);
    font-family: var(--font-family);
    font-size: 14px;
    min-width: 300px;
    transition: all 0.2s ease;
}

#search-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
}

.filter {
    position: relative;
}

.filter-btn {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--primary-text);
    font-family: var(--font-family);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    background: var(--surface-hover);
}

.filter-btn i {
    transition: transform 0.2s ease;
}

.filter.open .filter-btn i {
    transform: rotate(180deg);
}

.dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 200px;
    overflow: hidden;
    box-shadow: 0 8px 16px var(--shadow-color);
    z-index: 10;
    display: none;
    animation: fadeIn 0.15s ease-out;
}

.filter.open .dropdown-menu {
    display: block;
}

.dropdown-menu a {
    display: block;
    padding: 10px 14px;
    color: var(--primary-text);
    text-decoration: none;
    font-size: 14px;
}

.dropdown-menu a:hover {
    background: var(--accent-color);
    color: #fff;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.track-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.track-item {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    background: linear-gradient(90deg, var(--surface-color) 0%, rgba(22, 27, 34, 0.5) 100%);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    border-left: 3px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.track-item:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.1), transparent);
    transition: left 0.4s ease;
}

.track-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.track-item:hover:before {
    left: 100%;
}

.track-item.playing {
    border-left-color: var(--accent-color);
    box-shadow: 0 0 15px rgba(88, 166, 255, 0.15);
}

.track-info {
    flex-grow: 1;
}

.track-info .title {
    font-weight: 600;
}

.track-info .description {
    font-size: 13px;
    color: var(--secondary-text);
    margin-top: 4px;
}

.track-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    padding-left: 16px;
}

.track-duration {
    font-size: 14px;
    color: var(--secondary-text);
    width: 50px;
    text-align: right;
}

.fav-btn-track {
    background: none;
    border: none;
    color: var(--secondary-text);
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s ease;
}

.fav-btn-track:hover {
    color: var(--accent-hover);
}

.fav-btn-track.favorited {
    color: #FFD700;
}

/* Player Container */
.player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(15, 19, 25, 0.8);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    padding: 16px 24px;
    display: grid;
    grid-template-columns: 250px 1fr 250px;
    align-items: center;
    gap: 24px;
    z-index: 100;
}

.player-info {
    text-align: left;
}

#player-title {
    font-weight: 600;
}

#player-artist {
    font-size: 13px;
    color: var(--secondary-text);
}

.player-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
}

.control-btn {
    background: none;
    border: none;
    color: var(--primary-text);
    font-size: 18px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
}

.control-btn:hover {
    background: var(--surface-hover);
}

.play-btn {
    font-size: 22px;
    background: var(--accent-color);
    color: #fff;
}

.play-btn:hover {
    background: var(--accent-hover);
}

.progress-container {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.progress-container span {
    font-size: 12px;
    color: var(--secondary-text);
    min-width: 35px;
    text-align: center;
}

#waveform-container {
    flex-grow: 1;
    height: 60px;
    cursor: pointer;
}

.extra-controls {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
}

.volume-control, .speed-control {
    position: relative;
    display: flex;
    align-items: center;
}

.volume-control input[type="range"] {
    -webkit-appearance: none;
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    background: var(--surface-hover);
    border-radius: 5px;
    padding: 0 5px;
}

.volume-control:hover input[type="range"] {
    width: 100px;
    opacity: 1;
    margin-left: 8px;
}

input[type="range"]::-webkit-slider-runnable-track {
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--primary-text);
    border-radius: 50%;
    margin-top: -5px;
    cursor: pointer;
}

.speed-options {
    display: none;
    position: absolute;
    bottom: calc(100% + 8px);
    right: 0;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 8px 16px var(--shadow-color);
    overflow: hidden;
}

.speed-control.open .speed-options {
    display: block;
}

.speed-options button {
    display: block;
    width: 100%;
    padding: 8px 16px;
    background: none;
    border: none;
    color: var(--primary-text);
    cursor: pointer;
    font-size: 14px;
    text-align: left;
}

.speed-options button:hover {
    background: var(--surface-hover);
}
.speed-options button.active {
    background: var(--accent-color);
    color: #fff;
}

#fav-btn.favorited {
    color: #FFD700;
}

/* Toast Notifications */
#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: #28a745;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    box-shadow: 0 4px 12px var(--shadow-color);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(calc(100% + 20px));
    animation: slideIn 0.5s forwards, slideOut 0.5s forwards 3s;
}

.toast.error {
    background: #dc3545;
}

.toast i {
    font-size: 20px;
}

@keyframes slideIn {
    from { transform: translateX(calc(100% + 20px)); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(calc(100% + 20px)); opacity: 0; }
}

/* Responsive */
@media (max-width: 900px) {
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
    }
    .controls {
        width: 100%;
        justify-content: space-between;
    }
    #search-input {
        min-width: 0;
        width: 100%;
    }
    .player-container {
        grid-template-columns: 1fr;
        padding: 16px;
        height: auto;
    }
    .player-info, .extra-controls { display: none; }
    .progress-container {
        order: -1;
        width: 100%;
        padding-bottom: 12px;
    }
}



/* Contenedor general */
.neo-nav-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 340px; /* MÁS LARGO */
    padding: 18px 35px;
    background: #1a1a1c;
    border-radius: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(6px);
    box-shadow:
        10px 10px 22px #0d0d0e,
        -10px -10px 22px #2b2b2d;
    z-index: 999999;
}

/* Botones */
.neo-nav-btn {
    background: #1a1a1c;
    border: none;
    width: 65px;
    height: 65px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #e8e8e8;
    box-shadow:
        7px 7px 14px #0d0d0e,
        -7px -7px 14px #2b2b2d;
    transition: 0.18s ease;
}

/* Tamaño del icono */
.neo-nav-icon {
    width: 32px;
    height: 32px;
}

/* Efecto al presionar */
.neo-nav-btn:active {
    box-shadow:
        inset 7px 7px 14px #0d0d0e,
        inset -7px -7px 14px #2b2b2d;
    transform: scale(0.90);
}
    </style>
</head>
<body>
    <menutech-chatbot></menutech-chatbot>
    <!-- NAVBAR NEOMÓRFICO INFERIOR -->
<div class="neo-nav-container">
    <button id="neoNavBack" class="neo-nav-btn">
        <svg viewBox="0 0 24 24" class="neo-nav-icon">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2"
                  fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <button id="neoNavHome" class="neo-nav-btn">
        <svg viewBox="0 0 24 24" class="neo-nav-icon">
            <path d="M3 11l9-7 9 7v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 
                     2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                  stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
</div>
    <div class="container">
        <header>
            <div class="brand">
                <img src="https://menutech.services/assets/img/logomt.png" alt="Logo" class="logo">
            </div>
            <div class="controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar audios...">
                </div>
                <div class="filter">
                    <button class="filter-btn" id="filter-btn">
                        <span id="filter-label">Todos</span> <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="filter-dropdown">
                        <a href="#" data-filter="Todos">Todos</a>
                        <a href="#" data-filter="Customer Services">Customer Services</a>
                        <a href="#" data-filter="Opening">Opening</a>
                        <a href="#" data-filter="Closers">Closers</a>
                        <a href="#" data-filter="Favoritos">Favoritos</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="track-list" id="track-list"></main>
    </div>

    <div class="player-container" id="player-container" style="display: none;">
        <div class="player-info">
            <div id="player-title">--</div>
            <div id="player-artist">--</div>
        </div>
        <div class="player-controls">
            <button id="prev-btn" class="control-btn"><i class="fas fa-step-backward"></i></button>
            <button id="play-pause-btn" class="control-btn play-btn"><i class="fas fa-play"></i></button>
            <button id="next-btn" class="control-btn"><i class="fas fa-step-forward"></i></button>
        </div>
        <div class="progress-container">
            <span id="current-time">0:00</span>
            <div id="waveform-container"></div>
            <span id="total-time">0:00</span>
        </div>
        <div class="extra-controls">
            <div class="volume-control">
                <button id="volume-btn" class="control-btn"><i class="fas fa-volume-up"></i></button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
            <div class="speed-control">
                <button id="speed-btn" class="control-btn">1x</button>
                <div class="speed-options" id="speed-options">
                    <button data-speed="0.5">0.5x</button>
                    <button data-speed="0.75">0.75x</button>
                    <button data-speed="1" class="active">1x</button>
                    <button data-speed="1.5">1.5x</button>
                    <button data-speed="2">2x</button>
                </div>
            </div>
            <button id="fav-btn" class="control-btn"><i class="far fa-star"></i></button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
      <script src="https://menutech.xyz/menutechUI.min.js"></script>
    <script>
        // Botón Atrás
document.getElementById("neoNavBack").addEventListener("click", () => {
    if (window.history.length > 1) window.history.back();
});

// Botón Inicio
document.getElementById("neoNavHome").addEventListener("click", () => {
    window.location.href = "index.html"; // Cambia por tu ruta principal
});
        document.addEventListener('DOMContentLoaded', () => {
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = "https://ojpyfjgkffmzwvukjagf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qcHlmamdrZmZtend2dWtqYWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDIwMzYsImV4cCI6MjA3OTcxODAzNn0.dlVYmoMumBse_O1PLBx0FeNITqY4YktefD6l_uonSgo";
    const supabase = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM ELEMENTS ---
    const trackListEl = document.getElementById('track-list');
    const searchInput = document.getElementById('search-input');
    const filterBtn = document.getElementById('filter-btn');
    const filterLabel = document.getElementById('filter-label');
    const filterDropdown = document.getElementById('filter-dropdown');
    const playerContainer = document.getElementById('player-container');
    const playerTitle = document.getElementById('player-title');
    const playerArtist = document.getElementById('player-artist');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentTimeEl = document.getElementById('current-time');
    const totalTimeEl = document.getElementById('total-time');
    const volumeBtn = document.getElementById('volume-btn');
    const volumeSlider = document.getElementById('volume-slider');
    const speedBtn = document.getElementById('speed-btn');
    const speedOptions = document.getElementById('speed-options');
    const favBtn = document.getElementById('fav-btn');
    const toastContainer = document.getElementById('toast-container');

    // --- STATE ---
    let allTracks = [];
    let filteredTracks = [];
    let currentTrackIndex = -1;
    let wavesurfer;
    const favoritesKey = 'pro_audio_favorites_v1';
    let favorites = new Set(JSON.parse(localStorage.getItem(favoritesKey) || '[]'));
    let currentFilter = 'Todos';
    let searchTerm = '';

    // --- INITIALIZATION ---
    async function init() {
        initializePlayer();
        setupEventListeners();
        await loadTracks();
    }

    // --- SUPABASE DATA FETCHING ---
    async function loadTracks() {
        try {
            const { data, error } = await supabase
                .from("audio_items")
                .select("*")
                .order("created_at", { ascending: false });

            if (error) throw error;

            allTracks = data.map(t => ({
                id: t.id,
                title: t.title || "Sin título",
                description: t.description || "",
                category: t.category || "General", // Using category field
                src: t.file_url
            }));
            
            applyFiltersAndRender();
        } catch (err) {
            console.error(err);
            showToast("Error al cargar los audios", "error");
        }
    }

    // --- PLAYER INITIALIZATION ---
    function initializePlayer() {
        wavesurfer = WaveSurfer.create({
            container: '#waveform-container',
            waveColor: 'rgba(139, 148, 158, 0.5)',
            progressColor: '#58A6FF',
            height: 50,
            barWidth: 3,
            barGap: 2,
            barRadius: 3,
            normalize: true,
            backend: 'MediaElement',
            mediaControls: false,
        });

        wavesurfer.on('ready', () => {
            totalTimeEl.textContent = formatTime(wavesurfer.getDuration());
            wavesurfer.play();
        });

        wavesurfer.on('audioprocess', () => {
            currentTimeEl.textContent = formatTime(wavesurfer.getCurrentTime());
        });

        wavesurfer.on('play', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            updatePlayingStatusInList(true);
        });

        wavesurfer.on('pause', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            updatePlayingStatusInList(false);
        });
        
        wavesurfer.on('finish', () => {
            playNext();
        });
    }

    // --- UI RENDERING ---
    function renderTracks(tracksToRender) {
        trackListEl.innerHTML = '';
        if (tracksToRender.length === 0) {
            trackListEl.innerHTML = '<p style="color: var(--secondary-text); padding: 20px;">No se encontraron resultados.</p>';
            return;
        }
        tracksToRender.forEach((track, index) => {
            const isFavorited = favorites.has(track.id);
            const isPlaying = index === currentTrackIndex;
            
            const trackEl = document.createElement('div');
            trackEl.className = 'track-item';
            trackEl.classList.toggle('playing', isPlaying);
            trackEl.dataset.index = index;

            trackEl.innerHTML = `
                <div class="track-info">
                    <div class="title">${escapeHtml(track.title)}</div>
                    <div class="description">${escapeHtml(track.description)}</div>
                </div>
                <div class="track-actions">
                    <button class="fav-btn-track ${isFavorited ? 'favorited' : ''}" data-id="${track.id}">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
            `;
            
            trackEl.querySelector('.track-info').addEventListener('click', () => playTrack(index));
            trackEl.querySelector('.fav-btn-track').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(track.id);
            });
            
            trackListEl.appendChild(trackEl);
        });
    }
    
    // --- FILTERING AND SEARCHING ---
    function applyFiltersAndRender() {
        let tempTracks = [...allTracks];

        // Filter by category
        if (currentFilter !== 'Todos') {
            if (currentFilter === 'Favoritos') {
                tempTracks = tempTracks.filter(t => favorites.has(t.id));
            } else {
                tempTracks = tempTracks.filter(t => t.category === currentFilter);
            }
        }

        // Filter by search term
        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            tempTracks = tempTracks.filter(t =>
                t.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                t.description.toLowerCase().includes(lowerCaseSearchTerm) ||
                t.category.toLowerCase().includes(lowerCaseSearchTerm)
            );
        }

        filteredTracks = tempTracks;
        renderTracks(filteredTracks);
    }


    // --- PLAYER CONTROLS ---
    function playTrack(index) {
        if (index < 0 || index >= filteredTracks.length) return;
        
        const previousIndex = currentTrackIndex;
        currentTrackIndex = index;
        
        const track = filteredTracks[index];
        wavesurfer.load(track.src);
        
        playerContainer.style.display = 'grid';
        playerTitle.textContent = track.title;
        playerArtist.textContent = track.category;

        updateFavoriteButtonState();
        
        // Update class on previous and new track item
        if (previousIndex !== -1) {
             const prevEl = trackListEl.querySelector(`.track-item[data-index="${previousIndex}"]`);
             if(prevEl) prevEl.classList.remove('playing');
        }
        const newEl = trackListEl.querySelector(`.track-item[data-index="${currentTrackIndex}"]`);
        if(newEl) newEl.classList.add('playing');
    }

    function playNext() {
        const nextIndex = (currentTrackIndex + 1) % filteredTracks.length;
        playTrack(nextIndex);
    }
    
    function playPrev() {
        const prevIndex = (currentTrackIndex - 1 + filteredTracks.length) % filteredTracks.length;
        playTrack(prevIndex);
    }

    function updatePlayingStatusInList(isPlaying) {
        const el = trackListEl.querySelector(`.track-item[data-index="${currentTrackIndex}"]`);
        if (el) {
            el.classList.toggle('playing', isPlaying);
        }
    }


    // --- FAVORITES ---
    function toggleFavorite(trackId) {
        if (favorites.has(trackId)) {
            favorites.delete(trackId);
            showToast("Eliminado de favoritos");
        } else {
            favorites.add(trackId);
            showToast("Añadido a favoritos");
        }
        saveFavorites();
        updateFavoriteButtonState(trackId);
        if (currentFilter === 'Favoritos') {
            applyFiltersAndRender();
        }
    }

    function saveFavorites() {
        localStorage.setItem(favoritesKey, JSON.stringify(Array.from(favorites)));
    }
    
    function updateFavoriteButtonState(trackIdToUpdate = null) {
        const currentTrack = filteredTracks[currentTrackIndex];
        if (currentTrack) {
            const isFav = favorites.has(currentTrack.id);
            favBtn.classList.toggle('favorited', isFav);
            favBtn.innerHTML = `<i class="${isFav ? 'fas' : 'far'} fa-star"></i>`;
        }
        
        // Update list item if a specific one was clicked
        if (trackIdToUpdate) {
            const trackItemBtn = document.querySelector(`.fav-btn-track[data-id="${trackIdToUpdate}"]`);
            if (trackItemBtn) {
                trackItemBtn.classList.toggle('favorited', favorites.has(trackIdToUpdate));
            }
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        playPauseBtn.addEventListener('click', () => wavesurfer.playPause());
        nextBtn.addEventListener('click', playNext);
        prevBtn.addEventListener('click', playPrev);

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            wavesurfer.setVolume(volume);
            volumeBtn.innerHTML = volume > 0 ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        });

        volumeBtn.addEventListener('click', () => {
            if (wavesurfer.getVolume() > 0) {
                wavesurfer.setVolume(0);
                volumeSlider.value = 0;
                volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else {
                wavesurfer.setVolume(1);
                volumeSlider.value = 1;
                volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        });
        
        speedBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            speedOptions.parentElement.classList.toggle('open');
        });

        speedOptions.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const speed = parseFloat(e.target.dataset.speed);
                wavesurfer.setPlaybackRate(speed);
                speedBtn.textContent = `${speed}x`;
                speedOptions.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                speedOptions.parentElement.classList.remove('open');
            });
        });
        
        favBtn.addEventListener('click', () => {
            if(currentTrackIndex !== -1) {
                toggleFavorite(filteredTracks[currentTrackIndex].id);
            }
        });
        
        searchInput.addEventListener('input', () => {
            searchTerm = searchInput.value;
            applyFiltersAndRender();
        });

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            filterBtn.parentElement.classList.toggle('open');
        });
        
        filterDropdown.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                currentFilter = e.target.dataset.filter;
                filterLabel.textContent = currentFilter;
                applyFiltersAndRender();
                filterBtn.parentElement.classList.remove('open');
            });
        });

        document.addEventListener('click', () => {
            filterBtn.parentElement.classList.remove('open');
            speedOptions.parentElement.classList.remove('open');
        });

        window.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') {
                e.preventDefault();
                wavesurfer.playPause();
            }
        });
    }

    // --- UTILITIES ---
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
    }

    function escapeHtml(s) {
        return (s || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]);
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3500);
    }
    
    // --- START THE APP ---
    init();
});

    </script>
</body>
</html>
